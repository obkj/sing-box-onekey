name: Sync Sing-box Kernel to Releases

on:
  # schedule:
  #  - cron: '0 0 * * *'  # 每天 00:00 UTC 运行
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get latest sing-box release
        id: get_latest_release
        run: |
          LATEST_TAG=$(curl -sL "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | jq -r '.tag_name // empty')
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          VERSION="${LATEST_TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "::set-output name=version::${VERSION}"
          echo "::set-output name=latest_tag::${LATEST_TAG}"

      - name: Download sing-box
        id: download
        run: |
          VERSION=${{ steps.get_latest_release.outputs.version }}
          LATEST_TAG=${{ steps.get_latest_release.outputs.latest_tag }}
          
          # 下载所有常用架构
          for ARCH in amd64 386 arm64 armv7 s390x; do
            FILE="sing-box-${VERSION}-linux-${ARCH}.tar.gz"
            URL="https://github.com/SagerNet/sing-box/releases/download/${LATEST_TAG}/${FILE}"
            echo "Downloading $FILE..."
            curl -sLo "$FILE" "$URL"
            
            # 兼容脚本逻辑：脚本中将 armv7 映射为 arm，因此复制一份命名为 linux-arm
            if [ "$ARCH" == "armv7" ]; then
              cp "$FILE" "sing-box-${VERSION}-linux-arm.tar.gz"
            fi
          done

      - name: Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: sing-box-*.tar.gz
          tag: ${{ steps.get_latest_release.outputs.latest_tag }}
          overwrite: true
          file_glob: true
